<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="jquery-ui.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"/>
    <link rel="stylesheet" href="pe-icon-7-stroke/css/pe-icon-7-stroke.css">
    <link rel="stylesheet" href="pe-icon-7-stroke/css/helper.css">
    <link rel="stylesheet" href="style.css"/>
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@2.0.4/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-renderers@2.0.2/dist/esri-leaflet-renderers.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script>
    	  $( function() {$( "#tools" ).draggable();} );
    	  $( function() {$( "#chart" ).draggable();} );
    </script>
  </head>

  <body>
  	<div id="mapid"></div>
  	<div id="tools" class="ui-widget-content">
  		<div class="container">
  			<div class="row justify-content-center">
  				<div class="col text-center">
  					<span class="pe-7s-expand1 pe-4x pe-va"></span>
  				</div>
  			</div>
  			<br>
  			<br>
  			<div class="row justify-content-center">
  				<div class="col text-center">
  					<span class="pe-7s-plus pe-4x pe-va"></span>
  				</div>
  			</div>
  			<br>
  			<br>
  			<div class="row justify-content-center">
  				<div class="col text-center">
  					<span class="pe-7s-less pe-4x pe-va"></span>
  				</div>
  			</div>
  			<br>
  			<br>
  			<div class="row justify-content-center">
  				<div class="col text-center">
					<p><i class="pe-7s-close-circle pe-4x pe-va"></i></p>
				</div>
  			</div>	
  		</div>
  	</div>
  	  	<div id="chart" class="ui-widget-content">
  		<div class="container">
  			<div class="row justify-content-center">
  				<div class="col">
  					<h1>CHART</h1>
  					<ul>
  						<li>depress buttons on click and show selection</li>
  						<li>only load parcels in view</li>
  						<li>show loading gif on pan/zoom as new parcels are loaded</li>
  					</ul>
  				</div>
  			</div>
  		</div>
  	</div>
  	<script> 
  	var map = L.map('mapid').setView([32.93, -97.22], 17);
  	var clicked = [];
  	var intersected = [];

  	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    	maxZoom: 18,
    	id: 'mapbox.streets',
    	accessToken: 'pk.eyJ1IjoiYnJ1bGVjIiwiYSI6IlpEOGRJVkUifQ.SDYry6LIIHfMMpajIkFCAg'
	}).addTo(map);

	function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			dashArray: '3',
			fillOpacity: 0.1,
			fillColor: 'white'
		};
	}

	function highlightFeature(e) {
    	var layer = e.target;
    	if (clicked.indexOf(e.target.feature.id) < 0 && intersected.indexOf(e.target.feature.id) < 0) {
		    layer.setStyle({
		        weight: 5,
		        color: '#1AD4D7',
		        dashArray: '',
		        fillOpacity: 0.7,
		        fillColor: '#A7ECED'
		    });
		}

	    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
	        layer.bringToFront();
	    }
	}

	function resetHighlight(e) {
		var layer = e.target;
		if (clicked.indexOf(e.target.feature.id) < 0 && intersected.indexOf(e.target.feature.id) < 0) {
			layer.setStyle({
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 0.1,
				fillColor: 'white'
			});

	    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
	        layer.bringToFront();
	    	}
		}
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: clickedFeature
		});
	}

  	function clickedFeature(e) {
    	var layer = e.target;

    	if (typeof bufLyr !== 'undefined') {
    		map.removeLayer(bufLyr);
    		parcels.resetStyle();
    	}

	    layer.setStyle({
	        weight: 5,
	        color: '#666',
	        dashArray: '',
	        fillOpacity: 0.7,
	        fillColor: 'red'
	    });

	    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
	        layer.bringToFront();
	    }
	    clicked.push(e.target.feature.id);


	    var poly = turf.polygon([layer.feature.geometry.coordinates[0]])
	    var buffered = turf.buffer(poly, 0.0568182, 'miles');
	    bufLyr = L.geoJson(buffered).addTo(map);

	    parcels.query()["intersects"](buffered).ids(function(error, ids){
	    	intersected = ids;
			OIDs = ids.join();
			for (var i = ids.length - 1; i >= 0; i--) {
				parcels.setFeatureStyle(ids[i], { color: 'red', weight: 3 });
      			};
  			//parcels.setWhere("OBJECTID IN (" + OIDs + ")")
	    });

	    //var clipped = turf.bboxClip(poly, buffered)
	    //L.geoJson(clipped).addTo(map);
	}

	var parcels = L.esri.featureLayer({url: 'https://mapit.tarrantcounty.com/arcgis/rest/services/Dynamic/TADParcels/MapServer/0', style: style, onEachFeature: onEachFeature}).addTo(map);

    //parcels.bindPopup(function(evt) {
    //	return L.Util.template('<h3>{GIS_LINK}</h3><hr /><p>{STREETNUMBER} {STREETNAME} {STREETTYPE}', evt.feature.properties);
	//}); 
  	</script>
  </body>
</html>